<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ symbol }} Analysis - StockAnalyzer AI</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <a href="/" class="text-white text-xl font-bold">
                            <i class="fas fa-chart-line mr-2"></i>
                            StockAnalyzer AI
                        </a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-white hover:text-gray-200">
                        <i class="fas fa-home mr-1"></i>
                        Home
                    </a>
                    <div class="text-white text-sm">
                        <i class="fas fa-brain mr-1"></i>
                        AI-Powered Analysis
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4">
                <i class="fas fa-spinner loading text-blue-600 text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Analyzing {{ symbol }}</h2>
            <p class="text-gray-600">Our AI is processing technical indicators and fundamental metrics...</p>
        </div>

        <!-- Analysis Results -->
        <div id="analysisResults" class="hidden">
            <!-- Results will be populated here -->
        </div>
    </div>

    <script>
        const symbol = '{{ symbol }}';
        let currentAnalysis = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            analyzeStock(symbol);
        });

        // Analyze stock
        async function analyzeStock(symbol) {
            try {
                const response = await fetch(`/api/analysis/report/${symbol}`);
                const data = await response.json();
                currentAnalysis = data.report;
                displayAnalysisResults(data.report);
                hideLoadingState();
            } catch (error) {
                console.error('Error analyzing stock:', error);
                hideLoadingState();
                showError('Error analyzing stock. Please try again.');
            }
        }

        // Display analysis results
        function displayAnalysisResults(analysis) {
            const container = document.getElementById('analysisResults');
            
            const recommendation = analysis.recommendation;
            const score = recommendation.score;
            const riskLevel = recommendation.risk_level;
            
            // Determine recommendation color
            let recColor = 'gray';
            if (recommendation.recommendation.includes('BUY')) recColor = 'green';
            else if (recommendation.recommendation.includes('SELL')) recColor = 'red';
            
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <!-- Header -->
                    <div class="text-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">${analysis.symbol}</h2>
                        <h3 class="text-xl text-gray-600 mb-4">${analysis.company_name}</h3>
                        <div class="flex justify-center items-center space-x-4">
                            <span class="text-sm text-gray-500">${analysis.sector} • ${analysis.industry}</span>
                        </div>
                    </div>

                    <!-- Recommendation Card -->
                    <div class="bg-gradient-to-r from-${recColor}-50 to-${recColor}-100 rounded-lg p-6 mb-6">
                        <div class="text-center">
                            <h3 class="text-2xl font-bold text-${recColor}-800 mb-2">${recommendation.recommendation}</h3>
                            <div class="flex justify-center items-center space-x-4 mb-4">
                                <span class="text-lg font-semibold text-${recColor}-700">Score: ${score}/100</span>
                                <span class="text-lg font-semibold text-gray-700">Risk: ${riskLevel}</span>
                                <span class="text-lg font-semibold text-gray-700">Confidence: ${Math.round(recommendation.confidence * 100)}%</span>
                            </div>
                            <div class="text-sm text-gray-600">
                                Expected Return: ${(recommendation.expected_return * 100).toFixed(2)}%
                            </div>
                        </div>
                    </div>

                    <!-- Reasons -->
                    <div class="mb-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">Analysis Reasons:</h4>
                        <ul class="list-disc list-inside space-y-1">
                            ${recommendation.reasons.map(reason => `<li class="text-gray-700">${reason}</li>`).join('')}
                        </ul>
                    </div>

                    <!-- Technical Analysis -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3">Technical Indicators</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">RSI (14):</span>
                                    <span class="font-semibold">${analysis.technical_analysis.rsi.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">MACD:</span>
                                    <span class="font-semibold">${analysis.technical_analysis.macd.toFixed(4)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">SMA 20:</span>
                                    <span class="font-semibold">$${analysis.technical_analysis.sma_20.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">SMA 50:</span>
                                    <span class="font-semibold">$${analysis.technical_analysis.sma_50.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">SMA 200:</span>
                                    <span class="font-semibold">$${analysis.technical_analysis.sma_200.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold text-gray-900 mb-3">Fundamental Metrics</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">P/E Ratio:</span>
                                    <span class="font-semibold">${analysis.fundamental_analysis.pe_ratio.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">PEG Ratio:</span>
                                    <span class="font-semibold">${analysis.fundamental_analysis.peg_ratio.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Beta:</span>
                                    <span class="font-semibold">${analysis.fundamental_analysis.beta.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">EPS:</span>
                                    <span class="font-semibold">$${analysis.fundamental_analysis.eps.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Dividend Yield:</span>
                                    <span class="font-semibold">${(analysis.fundamental_analysis.dividend_yield * 100).toFixed(2)}%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-center space-x-4">
                        <button onclick="saveReport()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download mr-2"></i>
                            Save Report
                        </button>
                        <button onclick="shareReport()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-share mr-2"></i>
                            Share
                        </button>
                        <a href="/" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                            <i class="fas fa-home mr-2"></i>
                            Back to Home
                        </a>
                    </div>
                </div>
            `;
            
            container.classList.remove('hidden');
        }

        // Hide loading state
        function hideLoadingState() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        // Show error
        function showError(message) {
            const container = document.getElementById('analysisResults');
            container.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-3xl mb-4"></i>
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Analysis Error</h3>
                    <p class="text-red-600 mb-4">${message}</p>
                    <a href="/" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-home mr-2"></i>
                        Back to Home
                    </a>
                </div>
            `;
            container.classList.remove('hidden');
        }

        // Save report
        function saveReport() {
            if (!currentAnalysis) return;
            
            const reportText = generateReportText(currentAnalysis);
            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentAnalysis.symbol}_analysis_report.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Generate report text
        function generateReportText(analysis) {
            return `
STOCK ANALYSIS REPORT
=====================

Symbol: ${analysis.symbol}
Company: ${analysis.company_name}
Sector: ${analysis.sector}
Industry: ${analysis.industry}
Analysis Date: ${analysis.analysis_date}

RECOMMENDATION
==============
${analysis.recommendation.recommendation}
Score: ${analysis.recommendation.score}/100
Risk Level: ${analysis.recommendation.risk_level}
Confidence: ${Math.round(analysis.recommendation.confidence * 100)}%
Expected Return: ${(analysis.recommendation.expected_return * 100).toFixed(2)}%

ANALYSIS REASONS
================
${analysis.recommendation.reasons.map(reason => `• ${reason}`).join('\n')}

TECHNICAL ANALYSIS
=================
RSI (14): ${analysis.technical_analysis.rsi.toFixed(2)}
MACD: ${analysis.technical_analysis.macd.toFixed(4)}
MACD Signal: ${analysis.technical_analysis.macd_signal.toFixed(4)}
SMA 20: $${analysis.technical_analysis.sma_20.toFixed(2)}
SMA 50: $${analysis.technical_analysis.sma_50.toFixed(2)}
SMA 200: $${analysis.technical_analysis.sma_200.toFixed(2)}
Bollinger Upper: $${analysis.technical_analysis.bollinger_upper.toFixed(2)}
Bollinger Lower: $${analysis.technical_analysis.bollinger_lower.toFixed(2)}
ATR: ${analysis.technical_analysis.atr.toFixed(2)}

FUNDAMENTAL ANALYSIS
===================
P/E Ratio: ${analysis.fundamental_analysis.pe_ratio.toFixed(2)}
Forward P/E: ${analysis.fundamental_analysis.forward_pe.toFixed(2)}
PEG Ratio: ${analysis.fundamental_analysis.peg_ratio.toFixed(2)}
Price to Book: ${analysis.fundamental_analysis.price_to_book.toFixed(2)}
Beta: ${analysis.fundamental_analysis.beta.toFixed(2)}
EPS: $${analysis.fundamental_analysis.eps.toFixed(2)}
Dividend Yield: ${(analysis.fundamental_analysis.dividend_yield * 100).toFixed(2)}%
Profit Margin: ${(analysis.fundamental_analysis.profit_margin * 100).toFixed(2)}%
Return on Equity: ${(analysis.fundamental_analysis.return_on_equity * 100).toFixed(2)}%
Debt to Equity: ${analysis.fundamental_analysis.debt_to_equity.toFixed(2)}

RISK ASSESSMENT
===============
Volatility: ${analysis.risk_assessment.volatility.toFixed(4)}
Beta: ${analysis.risk_assessment.beta.toFixed(2)}
Risk Level: ${analysis.risk_assessment.risk_level}

DISCLAIMER
==========
This analysis is for informational purposes only and should not be considered as investment advice. 
Please conduct your own research and consult with a financial advisor before making investment decisions.
            `;
        }

        // Share report
        function shareReport() {
            if (!currentAnalysis) return;
            
            const reportText = generateReportText(currentAnalysis);
            
            if (navigator.share) {
                navigator.share({
                    title: `${currentAnalysis.symbol} Stock Analysis Report`,
                    text: reportText,
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(reportText).then(() => {
                    alert('Report copied to clipboard!');
                });
            }
        }
    </script>
</body>
</html>
